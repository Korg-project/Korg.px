"""
Stancil 1994 H₂⁺ and He₂⁺ cross-sections and equilibrium constants.

This module contains transcriptions of the tables from Stancil (1994),
who calculated free-free and bound-free absorption coefficients for H₂⁺ and He₂⁺.

Reference
---------
Stancil 1994: https://ui.adsabs.harvard.edu/abs/1994ApJ...430..360S/abstract
"""

# Enable 64-bit precision in JAX
import jax
jax.config.update("jax_enable_x64", True)

import jax.numpy as jnp

# Temperature grids (K)
Ts_H2plus = jnp.array([3150.0, 4200.0, 5040.0, 6300.0, 8400.0, 12600.0, 16800.0, 25200.0])
Ts_He2plus = jnp.array([4200.0, 6300.0, 8400.0, 12600.0, 16800.0, 25200.0, 33600.0, 50400.0])

# Equilibrium constants: K = n(H I) * n(H II) / n(H₂⁺) [cm⁻³]
K_H2plus_vals = 1e19 * jnp.array([0.9600, 9.7683, 29.997, 89.599, 265.32, 845.01, 1685.3, 4289.5])
K_He2plus_vals = 1e21 * jnp.array([0.3606, 2.6330, 7.1409, 21.097, 39.842, 87.960, 147.41, 293.57])

# Wavelength grids (Å) - converted from nm
λs_H2plus_ff = jnp.array([
    700.0, 800.0, 900.0, 1000.0, 1100.0, 1200.0, 1300.0, 1400.0, 1500.0, 1600.0, 1700.0, 1800.0,
    1900.0, 2000.0, 2100.0, 2200.0, 2300.0, 2400.0, 2500.0, 2600.0, 2700.0, 2800.0, 2900.0, 2950.0,
    3000.0, 3500.0, 4000.0, 4500.0, 5000.0, 6000.0, 7000.0, 8000.0, 9000.0, 10000.0, 20000.0,
    30000.0, 40000.0, 50000.0, 110000.0, 150000.0, 200000.0
])

λs_bf = jnp.array([
    500.0, 600.0, 700.0, 800.0, 900.0, 1000.0, 1100.0, 1200.0, 1300.0, 1400.0, 1500.0, 1600.0,
    1700.0, 1800.0, 1900.0, 2000.0, 2100.0, 2200.0, 2300.0, 2400.0, 2500.0, 2600.0, 2700.0, 2800.0,
    2900.0, 3000.0, 3500.0, 4000.0, 4500.0, 5000.0, 6000.0, 7000.0, 8000.0, 9000.0, 10000.0,
    20000.0, 30000.0, 45000.0, 50000.0, 100000.0, 150000.0, 200000.0
])

# H₂⁺ free-free cross-sections [10⁻³⁹ cm⁵]
# Table dimensions: (n_wavelengths, n_temperatures)
σ_H2plus_ff_table = jnp.array([
    [0.0174, 0.0154, 0.0142, 0.0130, 0.0116, 0.0100, 9.10e-3, 8.08e-3],
    [0.0280, 0.0246, 0.0227, 0.0207, 0.0184, 0.0158, 0.0143, 0.0126],
    [0.0394, 0.0346, 0.0319, 0.0290, 0.0257, 0.0220, 0.0199, 0.0175],
    [0.0514, 0.0451, 0.0416, 0.0378, 0.0336, 0.0287, 0.0259, 0.0227],
    [0.0640, 0.0562, 0.0519, 0.0471, 0.0418, 0.0357, 0.0322, 0.0283],
    [0.0770, 0.0676, 0.0624, 0.0567, 0.0504, 0.0431, 0.0389, 0.0341],
    [0.0903, 0.0794, 0.0733, 0.0666, 0.0592, 0.0506, 0.0457, 0.0401],
    [0.1040, 0.0914, 0.0843, 0.0767, 0.0682, 0.0584, 0.0527, 0.0464],
    [0.1177, 0.1035, 0.0956, 0.0869, 0.0773, 0.0663, 0.0599, 0.0527],
    [0.1317, 0.1158, 0.1070, 0.0973, 0.0866, 0.0743, 0.0672, 0.0592],
    [0.1456, 0.1281, 0.1184, 0.1078, 0.0960, 0.0824, 0.0746, 0.0658],
    [0.1597, 0.1405, 0.1299, 0.1183, 0.1054, 0.0906, 0.0821, 0.0725],
    [0.1737, 0.1530, 0.1414, 0.1288, 0.1149, 0.0988, 0.0896, 0.0793],
    [0.1877, 0.1654, 0.1529, 0.1394, 0.1243, 0.1071, 0.0972, 0.0861],
    [0.2017, 0.1777, 0.1644, 0.1499, 0.1338, 0.1154, 0.1048, 0.0930],
    [0.2156, 0.1901, 0.1759, 0.1605, 0.1433, 0.1237, 0.1125, 0.0998],
    [0.2294, 0.2023, 0.1873, 0.1709, 0.1527, 0.1319, 0.1201, 0.1068],
    [0.2431, 0.2145, 0.1987, 0.1814, 0.1622, 0.1402, 0.1277, 0.1137],
    [0.2568, 0.2266, 0.2099, 0.1917, 0.1716, 0.1485, 0.1354, 0.1206],
    [0.2703, 0.2387, 0.2211, 0.2020, 0.1809, 0.1567, 0.1430, 0.1276],
    [0.2836, 0.2506, 0.2322, 0.2123, 0.1902, 0.1649, 0.1506, 0.1345],
    [0.2969, 0.2624, 0.2433, 0.2225, 0.1994, 0.1731, 0.1582, 0.1414],
    [0.3100, 0.2741, 0.2542, 0.2325, 0.2086, 0.1812, 0.1657, 0.1483],
    [0.3165, 0.2799, 0.2596, 0.2376, 0.2131, 0.1853, 0.1695, 0.1518],
    [0.3230, 0.2857, 0.2650, 0.2425, 0.2177, 0.1893, 0.1732, 0.1552],
    [0.3858, 0.3419, 0.3176, 0.2913, 0.2621, 0.2290, 0.2103, 0.1894],
    [0.4451, 0.3952, 0.3677, 0.3378, 0.3048, 0.2674, 0.2463, 0.2228],
    [0.5011, 0.4457, 0.4152, 0.3821, 0.3456, 0.3044, 0.2812, 0.2555],
    [0.5539, 0.4935, 0.4603, 0.4243, 0.3848, 0.3401, 0.3150, 0.2873],
    [0.6511, 0.5821, 0.5442, 0.5032, 0.4583, 0.4078, 0.3795, 0.3484],
    [0.7388, 0.6625, 0.6207, 0.5756, 0.5262, 0.4710, 0.4402, 0.4064],
    [0.8186, 0.7362, 0.6911, 0.6425, 0.5895, 0.5303, 0.4975, 0.4615],
    [0.8918, 0.8042, 0.7563, 0.7049, 0.6488, 0.5864, 0.5518, 0.5141],
    [0.9596, 0.8675, 0.8173, 0.7633, 0.7047, 0.6395, 0.6036, 0.5644],
    [1.4600, 1.3450, 1.2830, 1.2170, 1.1460, 1.0680, 1.0260, 0.9815],
    [1.8050, 1.6820, 1.6170, 1.5470, 1.4740, 1.3940, 1.3510, 1.3060],
    [2.2000, 2.0750, 2.0090, 1.9390, 1.8650, 1.7860, 1.7450, 1.7000],
    [2.3130, 2.1880, 2.1220, 2.0520, 1.9790, 1.9010, 1.8590, 1.8160],
    [3.1800, 3.0620, 3.0000, 2.9360, 2.8690, 2.7980, 2.7610, 2.7230],
    [3.8110, 3.7000, 3.6420, 3.5820, 3.5200, 3.4560, 3.4220, 3.3870],
    [4.3230, 4.2180, 4.1640, 4.1080, 4.0500, 3.9900, 3.9580, 3.9260]
]) * 1e-39  # Convert to cm⁵

# H₂⁺ bound-free cross-sections [10⁻¹⁸ cm⁵]
σ_H2plus_bf_table = jnp.array([
    [7.34e-5, 1.43e-4, 2.04e-4, 2.87e-4, 3.89e-4, 4.97e-4, 5.49e-4, 5.98e-4],
    [0.0100, 0.0150, 0.0186, 0.0230, 0.0276, 0.0319, 0.0337, 0.0353],
    [0.1676, 0.1965, 0.2105, 0.2215, 0.2266, 0.2246, 0.2211, 0.2163],
    [0.8477, 0.8199, 0.7797, 0.7183, 0.6376, 0.5477, 0.5037, 0.4622],
    [2.1113, 1.8166, 1.6135, 1.3823, 1.1403, 0.9157, 0.8176, 0.7313],
    [3.4427, 2.8069, 2.4213, 2.0136, 1.6137, 1.2616, 1.1129, 0.9845],
    [4.3470, 3.5155, 3.0224, 2.5070, 2.0062, 1.5685, 1.3846, 1.2262],
    [4.6981, 3.8841, 3.3806, 2.8402, 2.3019, 1.8203, 1.6147, 1.4358],
    [4.6169, 3.9763, 3.5361, 3.0358, 2.5120, 2.0239, 1.8096, 1.6202],
    [4.2811, 3.8840, 3.5476, 3.1272, 2.6535, 2.1858, 1.9729, 1.7809],
    [3.8331, 3.6850, 3.4660, 3.1434, 2.7388, 2.3082, 2.1033, 1.9138],
    [3.3624, 3.4344, 3.3301, 3.1098, 2.7840, 2.4020, 2.2106, 2.0287],
    [2.9167, 3.1670, 3.1662, 3.0438, 2.7985, 2.4707, 2.2958, 2.1244],
    [2.5172, 2.9031, 2.9909, 2.9573, 2.7898, 2.5175, 2.3610, 2.2019],
    [2.1697, 2.6538, 2.8149, 2.8600, 2.7657, 2.5495, 2.4128, 2.2682],
    [1.8726, 2.4243, 2.6444, 2.7573, 2.7300, 2.5682, 2.4516, 2.3222],
    [1.6208, 2.2160, 2.4821, 2.6522, 2.6843, 2.5725, 2.4748, 2.3597],
    [1.4085, 2.0289, 2.3297, 2.5473, 2.6314, 2.5653, 2.4852, 2.3839],
    [1.2295, 1.8617, 2.1883, 2.4453, 2.5755, 2.5517, 2.4889, 2.4012],
    [1.0785, 1.7129, 2.0581, 2.3479, 2.5188, 2.5347, 2.4885, 2.4144],
    [0.9508, 1.5804, 1.9387, 2.2553, 2.4622, 2.5145, 2.4840, 2.4230],
    [0.8424, 1.4623, 1.8293, 2.1680, 2.4063, 2.4920, 2.4762, 2.4277],
    [0.7501, 1.3568, 1.7296, 2.0865, 2.3530, 2.4701, 2.4687, 2.4327],
    [0.6712, 1.2626, 1.6392, 2.0118, 2.3045, 2.4525, 2.4660, 2.4433],
    [0.6033, 1.1783, 1.5577, 1.9443, 2.2620, 2.4415, 2.4707, 2.4626],
    [0.5448, 1.1029, 1.4843, 1.8834, 2.2256, 2.4369, 2.4825, 2.4901],
    [0.3477, 0.8233, 1.2037, 1.6442, 2.0832, 2.4343, 2.5567, 2.6400],
    [0.2412, 0.6469, 1.0069, 1.4533, 1.9363, 2.3659, 2.5349, 2.6658],
    [0.1782, 0.5283, 0.8605, 1.2951, 1.7920, 2.2630, 2.4604, 2.6222],
    [0.1389, 0.4487, 0.7547, 1.1780, 1.6859, 2.1963, 2.4228, 2.6179],
    [0.0927, 0.3396, 0.6120, 1.0109, 1.5255, 2.0874, 2.3564, 2.6031],
    [0.0685, 0.2749, 0.5175, 0.8894, 1.3923, 1.9700, 2.2587, 2.5323],
    [0.0542, 0.2335, 0.4534, 0.8033, 1.2940, 1.8800, 2.1824, 2.4760],
    [0.0448, 0.2041, 0.4046, 0.7334, 1.2067, 1.7876, 2.0941, 2.3965],
    [0.0382, 0.1813, 0.3635, 0.6701, 1.1194, 1.6816, 1.9827, 2.2828],
    [0.0159, 0.0901, 0.1982, 0.3951, 0.7108, 1.1448, 1.3953, 1.6590],
    [0.0100, 0.0596, 0.1325, 0.2699, 0.4954, 0.8132, 1.0003, 1.1999],
    [6.88e-3, 0.0425, 0.0962, 0.1994, 0.3723, 0.6216, 0.7710, 0.9325],
    [6.41e-3, 0.0400, 0.0908, 0.1889, 0.3540, 0.5932, 0.7371, 0.8932],
    [3.56e-3, 0.0229, 0.0526, 0.1110, 0.2109, 0.3582, 0.4479, 0.5463],
    [2.50e-3, 0.0161, 0.0373, 0.0790, 0.1506, 0.2567, 0.3216, 0.3929],
    [1.90e-3, 0.0123, 0.0286, 0.0607, 0.1161, 0.1982, 0.2487, 0.3042]
]) * 1e-18  # Convert to cm⁵


def K_H2plus(T):
    """
    H₂⁺ equilibrium constant from Stancil 1994.

    K = n(H I) * n(H II) / n(H₂⁺) [cm⁻³]

    Parameters
    ----------
    T : float
        Temperature in K

    Returns
    -------
    float
        Equilibrium constant in cm⁻³
    """
    # Linear interpolation with linear extrapolation
    T = jnp.asarray(T)
    i = jnp.searchsorted(Ts_H2plus, T, side='right') - 1
    i = jnp.clip(i, 0, len(Ts_H2plus) - 2)

    T0 = Ts_H2plus[i]
    T1 = Ts_H2plus[i + 1]
    K0 = K_H2plus_vals[i]
    K1 = K_H2plus_vals[i + 1]

    t = jnp.where(T1 != T0, (T - T0) / (T1 - T0), 0.0)
    return K0 + t * (K1 - K0)


def σ_H2plus_bf(λ_angstrom, T):
    """
    H₂⁺ bound-free cross-section from Stancil 1994.

    Parameters
    ----------
    λ_angstrom : float
        Wavelength in Angstroms
    T : float
        Temperature in K

    Returns
    -------
    float
        Cross-section in cm⁵
    """
    # Convert to JAX arrays
    λ_angstrom = jnp.asarray(λ_angstrom)
    T = jnp.asarray(T)

    # Bilinear interpolation
    i_lambda = jnp.searchsorted(λs_bf, λ_angstrom, side='right') - 1
    i_T = jnp.searchsorted(Ts_H2plus, T, side='right') - 1

    # Clip to valid range for linear extrapolation
    i_lambda = jnp.clip(i_lambda, 0, len(λs_bf) - 2)
    i_T = jnp.clip(i_T, 0, len(Ts_H2plus) - 2)

    # Get grid points
    λ0 = λs_bf[i_lambda]
    λ1 = λs_bf[i_lambda + 1]
    T0 = Ts_H2plus[i_T]
    T1 = Ts_H2plus[i_T + 1]

    # Compute fractional positions
    t_lambda = jnp.where(λ1 != λ0, (λ_angstrom - λ0) / (λ1 - λ0), 0.0)
    t_T = jnp.where(T1 != T0, (T - T0) / (T1 - T0), 0.0)

    # Get corner values
    σ00 = σ_H2plus_bf_table[i_lambda, i_T]
    σ01 = σ_H2plus_bf_table[i_lambda, i_T + 1]
    σ10 = σ_H2plus_bf_table[i_lambda + 1, i_T]
    σ11 = σ_H2plus_bf_table[i_lambda + 1, i_T + 1]

    # Bilinear interpolation
    return ((1.0 - t_lambda) * (1.0 - t_T) * σ00 +
            (1.0 - t_lambda) * t_T * σ01 +
            t_lambda * (1.0 - t_T) * σ10 +
            t_lambda * t_T * σ11)


def σ_H2plus_ff(λ_angstrom, T):
    """
    H₂⁺ free-free cross-section from Stancil 1994.

    Parameters
    ----------
    λ_angstrom : float
        Wavelength in Angstroms
    T : float
        Temperature in K

    Returns
    -------
    float
        Cross-section in cm⁵
    """
    # Convert to JAX arrays
    λ_angstrom = jnp.asarray(λ_angstrom)
    T = jnp.asarray(T)

    # Bilinear interpolation
    i_lambda = jnp.searchsorted(λs_H2plus_ff, λ_angstrom, side='right') - 1
    i_T = jnp.searchsorted(Ts_H2plus, T, side='right') - 1

    # Clip to valid range for linear extrapolation
    i_lambda = jnp.clip(i_lambda, 0, len(λs_H2plus_ff) - 2)
    i_T = jnp.clip(i_T, 0, len(Ts_H2plus) - 2)

    # Get grid points
    λ0 = λs_H2plus_ff[i_lambda]
    λ1 = λs_H2plus_ff[i_lambda + 1]
    T0 = Ts_H2plus[i_T]
    T1 = Ts_H2plus[i_T + 1]

    # Compute fractional positions
    t_lambda = jnp.where(λ1 != λ0, (λ_angstrom - λ0) / (λ1 - λ0), 0.0)
    t_T = jnp.where(T1 != T0, (T - T0) / (T1 - T0), 0.0)

    # Get corner values
    σ00 = σ_H2plus_ff_table[i_lambda, i_T]
    σ01 = σ_H2plus_ff_table[i_lambda, i_T + 1]
    σ10 = σ_H2plus_ff_table[i_lambda + 1, i_T]
    σ11 = σ_H2plus_ff_table[i_lambda + 1, i_T + 1]

    # Bilinear interpolation
    return ((1.0 - t_lambda) * (1.0 - t_T) * σ00 +
            (1.0 - t_lambda) * t_T * σ01 +
            t_lambda * (1.0 - t_T) * σ10 +
            t_lambda * t_T * σ11)
